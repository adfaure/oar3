name: OAR3 - generates debian packages
on:
  push:
    branches:
      - "release-ci"
    tags:
      - .*

jobs:
    Generate-debian-packages:
      env:
        OUTPUT: debian-packages.tar.gz
      runs-on: ubuntu-latest
      steps:
        - name: Check out repository code
          uses: actions/checkout@v2
          # Connect to docker to have user-base docker rate limit instead of by ip
        - name: Connect to dockerhub
          run: echo $DOCKERTOKEN | docker login --username ${DOCKERUSER} --password-stdin
          env:
            DOCKERUSER: ${{ secrets.DOCKERUSER }}
            DOCKERTOKEN: ${{ secrets.DOCKERTOKEN }}
        - name: Clone debian's branch of oar
          uses: actions/checkout@v2
          with:
            repository: oar-team/oar3
            path: misc/deb-gen/build/oar3
            ref: debian/3.0"
        - name: Generate the debian packages
          run: cd ./misc/deb-gen && ./build-deb.sh
        - name: Create a compressed archive
          run: tar -czf ${{ env.OUTPUT }}  misc/deb-gen/build/*.deb
        - uses: actions/upload-artifact@v2
          with:
            name: ${{ env.OUTPUT }}
            path: ${{ env.OUTPUT }}